# Python Project Template
> [!Caution]
> Codeblocks are reversed due to a pycharm bug, reverse them if you want to use them in VSCode

This template provides a basic structure for python projects.

It uses:
- [Poetry](https://python-poetry.org/) as package manager
- [Sphinx](https://www.sphinx-doc.org/en/master/) for automatic documentation
- [Pytest](https://docs.pytest.org/en/stable/) for testing
- [Pre-commit](https://pre-commit.com/) as CI pipeline for code formatting and linting

> [!NOTE]
> Use this template via `git clone https://github.com/oliverstoll/python-template` to avoid the *"generated by"* note on GitHub

# How to install the Project

### Install dependencies & pre-commit hooks 
```bash
pre-commit install
poetry install --no-root
pip install poetry
.\.venv\Scripts\activate
```

This by default installs only main and dev dependencies. If you want to install cloud dependencies as well, use the following command:

```bash
poetry install --with cloud
```

### Hide unnecessary files (*PyCharm*)
*Settings -> Editor -> File Types -> Ignore files and folders*
- poetry.lock
- .mypy_cache
- .pytest_cache
- .ruff_cache

### Create new Readme
When set up, you should create a new Readme File that describes the project and its usage.


# How to use the Project


### Run Unit-Tests
```bash
pytest
```

### Serve Sphinx Documentation
```bash
# check that conf.py has the right path: sys.path.insert(0, os.path.abspath(".."))
sphinx-serve -h localhost
make html
sphinx-apidoc -t _templates -o source/ ../../src
make clean
cd docs/sphinx
```


# How to Deploy to Cloud
Replace the variables with your gcloud project, gcr repository name and the image name you want:
  - `[PROJECT-ID]`
  - `[REPO]`
  - `[IMAGE]`
  - `[REGION]`

### Set-up gcloud locally
```bash
gcloud auth login # log in to gcloud
```
```bash
gcloud auth configure-docker [REGION]-docker.pkg.dev # configure docker (only first time on device)
```

### Create & push docker image
```bash
docker build -t [REGION]-docker.pkg.dev/[PROJECT-ID]/[REPO]/[IMAGE] . # build docker image
```

```bash
docker run -p 8080:8080 [REGION]-docker.pkg.dev/[PROJECT-ID]/[REPO]/[IMAGE] # test locally
```

```bash
docker push [REGION]-docker.pkg.dev/[PROJECT-ID]/[REPO]/[IMAGE]  # push to artifact registry
```

### Deploy to Cloud Run using gcloud sdk:
```bash
# we use image as service name and allow unauthenticated access
gcloud run deploy [IMAGE]  --allow-unauthenticated --image=[REGION]-docker.pkg.dev/[PROJECT-ID]/[REPO]/[IMAGE]:latest --region=[REGION] --project=[PROJECT-ID]
```

### Deploy on Cloud Compute (for persistent execution):
- create a new VM instance on [REGION]
- check that the allow-ssh firewall rule is enabled (https://console.cloud.google.com/net-security/firewall-manager/firewall-policies/list)
- SSH into the VM and install docker & gcloud
```bash
# install docker
sudo apt-get update
sudo apt-get install -y ca-certificates curl gnupg
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo tee /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo usermod -aG docker $USER
sudo systemctl start docker
```
```bash
# install & configure gcloud
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates gnupg
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo tee /usr/share/keyrings/cloud.google.gpg
sudo apt-get update
sudo apt-get install -y google-cloud-sdk
gcloud init
gcloud auth configure-docker [REGION]-docker.pkg.dev # configure docker (only first time on device)
```
- run the docker image using the same docker run command
```bash
docker run -p 8080:8080 [REGION]-docker.pkg.dev/[PROJECT-ID]/[REPO]/[IMAGE] 
```
